# CPU 调度

## 什么是 CPU 调度
  - 按照一定的算法，从就绪队列中选择进程并交给 CPU 控制权
  - 如果没有就绪进程，会选择一个 空闲或 idle 进程

## CPU 调度解决的问题
  - What 选择哪个执行，调度算法
  - When 合适进行选择，调度时机
  - How 上下文切换

## CPU 何时调度
  - 进程终止或因为错误而终止
  - 新建进程，或进程变成就绪态
  - 运行到阻塞态
  - 运行到就绪态

## 进程切换这样包含两部分工作
  - 切换全局页目录以下载一个新的地址空间
  - 切换内核栈和硬件上下文，包括了内核执行新进程需要的全部信息，比如 CPU 相关寄存器

## 进程切换的基本步骤
  - A 下 CPU，B 上 CPU
  - 保存 A 的上下文环境，程序计数器，程序状态字，其他寄存器
  - 用新的状态和其他相关信息更新进程 A 的 PCB
  - 把 A 移动到合适队列（就绪，阻塞）
  - B 设置为运行
  - B 恢复上下文

## 上线文的开销
  - 直接开销
    - 保存和恢复寄存器
    - 切换地址空间
  - 简介开销
    - 高速缓存 Cache，缓冲区缓存 Buffer Cache 和 TLB( Translation Lookup Buffer ) 失效

## 调度算法的衡量指标
  - 吞吐量 Throughout
  - 周转时间 TT （ Turnarount Time ）
  - 反应时间 Response Time
  - CPU 利用率 CPU Utilization
  - 等待时间 Waiting Time

## 进程的优先级
  - 优先级
  - 静态 ？动态
  - 抢占方式
    - 可抢占式 Preemptive
      - 有更高优先级程序就绪后，系统强行剥夺正在运行的 CPU
    - Non-preemptive
      - 不被强占
  - I/O 密集型与 CPU 密集型
    - I/O 会更偏好，因为占用 CPU 时间相对短
  
## 时间片 Time slice 或 Quantum
  - 选择因素
    - 进程切换的开销
    - 响应时间的要求
    - 就绪进程个数
    - CPU 能力
    - 进程的行为

## 批处理系统中采用的调度算法
  - 先来先服务
    - 非强占，公平，不利于用户体验
  - 最短作业优先
    - 最短的平均周转时间
    - 不公平，长作业时间可能会有 “饥饿感”
  - 最短剩余时间
  - 最高响应比优先
  - Highest Response Ratio Next
    - 综合算法
    - 调度时先计算每个进程的响应比 R，之后总是选择 R 最高的

## 交互式系统中采用的调度算法
  - Round Robin
    - 周期性切换
    - 时钟中断
    - 时间片小的话，切换过于频繁
  - 虚拟轮转发 Virtual Round Robin
    - I/O 进入辅助队列，CPU 有限执行辅助队列，以免 I/O 总是尽快运行完
  - 最高优先级调度
    - 系统进程高于用户进程
    - 前台优先于后台
    - 操作系统更偏好 I/O 型进程
  - 多级反馈队列
  - 最短进程优先

## 优先级反转问题 Priority Inversion
  - 基于优先级的抢占式
  - 一个低优先级的进程持有一个高优先级进程需要的资源，使得高优先级等待低优先级进程运行
    - 影响
      - 系统错误
      - 高优先级进程停滞不前，导致系统性能降低
    - 解决方案
      - 设置优先级上限
      - 优先级继承，如果低优先级阻碍了高优先级进程，低优先级继承高优先级并执行完成
      - 使用中断禁止

## 多级反馈队列调度算法
  - Multilevel Feedback
    - 是 Unix 的一个分支 BSD, 5.3版采用的调度算法
    - 是一个综合调度算法
  - 算法
    - 设置多个就绪队列，第一季队列优先级最高
    - 不同就绪队列分配不同长度的时间片，第一级队列时间片最小；随着队列优先级别降低，时间片增大
    - 各个队列安装时间片轮转的方式执行
    - 新创建的进程就绪后都进入第一队列
    - 进程用完时间片后进入下一级队列
    - 若允许抢占，当一个优先级更高的进程就绪时，可以强占 CPU

## 典型操作系统采用的调度算法
  - UNIX    动态优先
  - 5.3BSD  多级反馈队列
  - Linux   抢占式调度
  - Windows 基于优先级的抢占式多任务调度
  - Solaris 综合调度算法

## Linux 算法发展历史
  - Linux2.4 检点的基于优先级调度
  - Linux2.6
    - O(1) 调度器
    - SD 调度器补丁
    - RSDL 调度器补丁
    - CFS 调度器（沿用至今，完全公平调度算法）

## Windows 线程调度
  - 调度单位是线程
  - 采用动态优先级。抢占式调度，结合时间配额的调整
    - 就绪线程按照优先级进入相应队列
    - 系统总是选择优先级最高的就绪线程
    - 同一优先级的各线程按时间片轮转调度
    - 多 CPU 系统允许多个线程并行运行
  - 引发线程调度的条件
    - 一个线程的优先级改变
    - 一个线程改变了他的亲和（Affinity）处理机集合
    - 以及其他和 unix 类似的处理机制
  - Windows 是使用 32 个线程优先级，分成三类
    - 实时优先级 16 - 31  实时优先级不改变其优先级
    - 可变优先级 1 - 15   优先级在一定范围内变化，基本优先级和当前优先级
    - 系统线程   0        零页线程，用于对系统中空闲物理页面清零

## 线程优先级提升与实践配额调整
  - Windows 的调度策略，解决线程的饥饿现象
    - 5 种情况会提升优先级
      - I/O 操作
      - 信号量或事件等待结束
      - 前台进程中的线程完成一个等待操作
      - 由于窗口活动而唤醒窗口线程
      - 线程处于就绪态超过一段时间还没有运行的饥饿显现